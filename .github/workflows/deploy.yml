
name: Deploy Bedrock + Sage

on:
  push:
    branches:
      - master
      - develop

  workflow_dispatch:
    inputs:
      app_env:
        description: "Override APP_ENV (live|dev). Leave empty to auto-detect from branch."
        required: false
        default: ""

env:
  APP_NAME: ${{ vars.APP_NAME }}
  THEME_NAME: ${{ vars.THEME_NAME }}

jobs:

############################################################
# 1. VALIDATE & DERIVE PATHS
############################################################
  sanity-and-derive:
    name: Derive & Validate Environment
    runs-on: ubuntu-latest
    outputs:
      app_env: ${{ steps.v.outputs.app_env }}
      deploy_path: ${{ steps.v.outputs.deploy_path }}
      theme_local_path: ${{ steps.v.outputs.theme_local_path }}
      theme_remote_path: ${{ steps.v.outputs.theme_remote_path }}

    steps:
      - id: v
        run: |
          BRANCH="${GITHUB_REF##*/}"
          OVERRIDE="${{ github.event.inputs.app_env || vars.APP_ENV }}"

          if [ -n "$OVERRIDE" ]; then
            APP_ENV="$OVERRIDE"
          else
            case "$BRANCH" in
              master) APP_ENV="live" ;;
              develop) APP_ENV="dev" ;;
              *) echo "::error ::Unsupported branch $BRANCH"; exit 1 ;;
            esac
          fi

          if [ -z "${{ env.APP_NAME }}" ] || [ -z "${{ env.THEME_NAME }}" ]; then
            echo "APP_NAME and THEME_NAME are required repo variables." >&2
            exit 1
          fi

          DEPLOY_PATH="/srv/users/serverpilot/apps/${APP_ENV}${{ env.APP_NAME }}"
          THEME_LOCAL="web/app/themes/${{ env.THEME_NAME }}"
          THEME_REMOTE="$DEPLOY_PATH/web/app/themes/${{ env.THEME_NAME }}"

          echo "app_env=$APP_ENV" >> $GITHUB_OUTPUT
          echo "deploy_path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
          echo "theme_local_path=$THEME_LOCAL" >> $GITHUB_OUTPUT
          echo "theme_remote_path=$THEME_REMOTE" >> $GITHUB_OUTPUT

############################################################
# 2. BUILD BEDROCK (COMPOSER)
############################################################
  build-bedrock:
    name: Build Bedrock (Composer)
    needs: sanity-and-derive
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2

      - uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - run: composer install --no-interaction --prefer-dist

      - uses: actions/upload-artifact@v4
        with:
          name: bedrock
          path: |
            composer.json
            composer.lock
            vendor
            .env

############################################################
# 3. BUILD SAGE (NODE + COMPOSER)
############################################################
  build-sage:
    name: Build Sage Assets (Node 20.20.0)
    needs: [sanity-and-derive, build-bedrock]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bedrock

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2

      - uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"
          cache: yarn
          cache-dependency-path: ${{ needs.sanity-and-derive.outputs.theme_local_path }}/yarn.lock

      - run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate

      - uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            ${{ needs.sanity-and-derive.outputs.theme_local_path }}/vendor
          key: composer-theme-${{ hashFiles(format('{0}/composer.lock', needs.sanity-and-derive.outputs.theme_local_path)) }}

      - name: Build Sage (fail fast)
        working-directory: ${{ needs.sanity-and-derive.outputs.theme_local_path }}
        env:
          NODE_ENV: production
        run: |
          composer install --prefer-dist --no-interaction --no-dev
          yarn install --immutable || yarn install
          yarn build --mode=production

      - uses: actions/upload-artifact@v4
        with:
          name: sage
          path: |
            web/app/themes/${{ env.THEME_NAME }}/public
            web/app/themes/${{ env.THEME_NAME }}/vendor
            web/app/themes/${{ env.THEME_NAME }}/node_modules
            web/app/themes/${{ env.THEME_NAME }}/.yarn

############################################################
# 4. DEPLOY (GIT-TRACKED SOURCES + THEME BUILDS, SERVER COMPOSER, FINALIZE)
############################################################
  deploy:
    name: Deploy via SSH + rsync
    needs: [sanity-and-derive, build-sage]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bedrock
          path: .

      - uses: actions/download-artifact@v4
        with:
          name: sage
          path: web/app/themes/${{ env.THEME_NAME }}

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      ############################################################
      # DETECT IF THIS APP USES BLADE ICONS / FONT AWESOME (owenvoke)
      ############################################################
      - name: Detect Blade Icons usage from composer.json
        id: detect_blade_icons
        run: |
          HAS=false
          # Look for either package in Bedrock composer.json
          if grep -qE '"blade-ui-kit\/blade-icons"' composer.json; then HAS=true; fi
          if grep -qE '"owenvoke\/blade-fontawesome"' composer.json; then HAS=true; fi
          echo "has_blade_icons=$HAS" >> "$GITHUB_OUTPUT"
          echo "Detected Blade Icons usage: $HAS"

      ############################################################
      # CHECK DEV PATH (skip deploy if missing in dev)
      ############################################################
      - name: Check/flag dev path existence
        id: devpath
        if: needs.sanity-and-derive.outputs.app_env == 'dev'
        run: |
          if ssh -o BatchMode=yes -o ConnectTimeout=10 serverpilot@${{ secrets.SERVER_IP }} "test -d '${{ needs.sanity-and-derive.outputs.deploy_path }}'"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip deploy if dev path missing
        if: needs.sanity-and-derive.outputs.app_env == 'dev' && steps.devpath.outputs.exists != 'true'
        run: |
          echo "Dev path missing. Skipping."
          # Write a brief run summary even when skipping
          {
            echo "### Deploy Summary"
            echo ""
            echo "- **Environment**: dev"
            echo "- **Dev path exists**: false"
            echo "- **Blade Icons in composer.json**: ${{ steps.detect_blade_icons.outputs.has_blade_icons }}"
            echo "- **Result**: Skipped deployment because dev path was not found."
          } >> $GITHUB_STEP_SUMMARY
          exit 0

      ############################################################
      # RSYNC TRACKED SOURCES (git-aware) + THEME BUILDS
      ############################################################
      - name: Deploy tracked sources (git-aware rsync)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          set -euxo pipefail
          REMOTE="serverpilot@${{ secrets.SERVER_IP }}"
          BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          ssh "$REMOTE" "mkdir -p '$BASE'"

          # Deploy exactly what's tracked in git (honors root + theme .gitignore)
          git ls-files -z \
            | rsync -azv --delete --from0 --files-from=- \
                --exclude 'vendor' \
                --exclude '.env' \
                --exclude 'web/wp' \
                --exclude 'web/app/uploads' \
                --exclude "web/app/themes/${{ env.THEME_NAME }}/public" \
                --exclude "web/app/themes/${{ env.THEME_NAME }}/vendor" \
                --exclude "web/app/themes/${{ env.THEME_NAME }}/node_modules" \
                --exclude "web/app/themes/${{ env.THEME_NAME }}/.yarn" \
                ./ "$REMOTE:$BASE/"

      - name: Deploy theme builds (public/vendor/node_modules/.yarn)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          set -euxo pipefail
          REMOTE="serverpilot@${{ secrets.SERVER_IP }}"
          BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          THEME="$BASE/web/app/themes/${{ env.THEME_NAME }}"
          SRC_THEME="web/app/themes/${{ env.THEME_NAME }}"
          ssh "$REMOTE" "mkdir -p '$THEME/public' '$THEME/vendor' '$THEME/node_modules' '$THEME/.yarn'"

          rsync -azv --delete "$SRC_THEME/public/"       "$REMOTE:$THEME/public/"
          rsync -azv --delete "$SRC_THEME/vendor/"       "$REMOTE:$THEME/vendor/"
          rsync -azv --delete "$SRC_THEME/node_modules/" "$REMOTE:$THEME/node_modules/" || true
          rsync -azv --delete "$SRC_THEME/.yarn/"        "$REMOTE:$THEME/.yarn/" || true

      ############################################################
      # SERVER-SIDE COMPOSER FOR BEDROCK (no vendor/.env rsync)
      # - Try --no-dev first (lean). If Blade Icons are required but missing,
      #   fall back to full install to cover packages living under require-dev.
      ############################################################
      - name: Install Bedrock Composer dependencies on server (with fallback)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc '
            set -euo pipefail
            BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
            cd "$BASE"

            export COMPOSER_ALLOW_SUPERUSER=1
            export COMPOSER_MEMORY_LIMIT=-1

            if command -v composer >/dev/null 2>&1; then
              COMPOSER="composer"
            else
              mkdir -p "$HOME/bin"
              php -r "copy(\"https://getcomposer.org/installer\", \"composer-setup.php\");"
              php composer-setup.php --install-dir="$HOME/bin" --filename=composer --quiet
              rm -f composer-setup.php
              COMPOSER="$HOME/bin/composer"
            fi

            echo "Running composer install --no-dev (first pass)…"
            $COMPOSER install --no-dev --prefer-dist --no-interaction

            HAS_BLADE_ICONS="${{ steps.detect_blade_icons.outputs.has_blade_icons }}"
            if [ "$HAS_BLADE_ICONS" = "true" ]; then
              if [ ! -d vendor/owenvoke/blade-fontawesome ] && [ ! -d vendor/blade-ui-kit/blade-icons ]; then
                echo "Blade Icons/FontAwesome not present after --no-dev. Running full install…"
                $COMPOSER install --prefer-dist --no-interaction
                echo "FALLBACK_FULL_INSTALL=1" > composer_fallback.env
              else
                echo "FALLBACK_FULL_INSTALL=0" > composer_fallback.env
              fi
            else
              echo "FALLBACK_FULL_INSTALL=0" > composer_fallback.env
            fi
          '

      ############################################################
      # REFRESH ACORN DISCOVERY & CACHES (conditionally)
      # - Create icons directory if app uses Blade Icons to avoid path errors.
      ############################################################
      - name: Refresh Acorn discovery & caches (conditional)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc '
            set -euo pipefail
            BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
            THEME_DIR="$BASE/web/app/themes/${{ env.THEME_NAME }}"
            ICONS_DIR="$THEME_DIR/resources/images/icons"
            cd "$BASE"

            if wp acorn --version >/dev/null 2>&1; then
              HAS_BLADE_ICONS="${{ steps.detect_blade_icons.outputs.has_blade_icons }}"

              # Ensure icons dir exists only when Blade Icons are used
              if [ "$HAS_BLADE_ICONS" = "true" ]; then
                mkdir -p "$ICONS_DIR"
              fi

              echo "Running: wp acorn package:discover"
              wp acorn package:discover || true

              if [ "$HAS_BLADE_ICONS" = "true" ]; then
                echo "Running: wp acorn icons:cache"
                wp acorn icons:cache || true
              else
                echo "Blade Icons not used in this app; skipping icons:cache"
              fi

              echo "Clearing Blade view & optimize caches"
              wp acorn view:clear || true
              wp acorn optimize:clear || true
            else
              echo "wp acorn not available; skipping Acorn steps."
            fi
          '

      ############################################################
      # FINALIZE — PERMISSIONS, DONE
      ############################################################
      - name: Finalize
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc "
            set -euo pipefail
            cd '${{ needs.sanity-and-derive.outputs.deploy_path }}'
            chown -R serverpilot:serverpilot .
            find . -type d -exec chmod 775 {} \;
            find . -type f -exec chmod 664 {} \;
            echo 'Deployment complete.'
          "

      ############################################################
      # SUMMARY — Append a markdown summary to the run
      ############################################################
      - name: Deployment Summary
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          set -euo pipefail
          APP_ENV="${{ needs.sanity-and-derive.outputs.app_env }}"
          HAS_BLADE="${{ steps.detect_blade_icons.outputs.has_blade_icons }}"
          DEV_EXISTS="${{ steps.devpath.outputs.exists }}"
          [ -z "${DEV_EXISTS:-}" ] && DEV_EXISTS="n/a"

          REMOTE="serverpilot@${{ secrets.SERVER_IP }}"
          BASE="${{ needs.sanity-and-derive.outputs.deploy_path }}"
          THEME="${BASE}/web/app/themes/${{ env.THEME_NAME }}"
          ICONS_DIR="${THEME}/resources/images/icons"

          # Pull runtime facts from the server for the summary
          FA_PKG=$(ssh "$REMOTE" "test -d '$BASE/vendor/owenvoke/blade-fontawesome' && echo yes || echo no")
          BLADE_ICONS=$(ssh "$REMOTE" "test -d '$BASE/vendor/blade-ui-kit/blade-icons' && echo yes || echo no")
          ICONS_DIR_EXISTS=$(ssh "$REMOTE" "test -d '$ICONS_DIR' && echo yes || echo no")
          FALLBACK_USED=$(ssh "$REMOTE" "test -f '$BASE/composer_fallback.env' && grep -q 'FALLBACK_FULL_INSTALL=1' '$BASE/composer_fallback.env' && echo yes || echo no")

          {
            echo "### Deploy Summary"
            echo ""
            echo "- **Environment**: ${APP_ENV}"
            echo "- **Dev path exists** (dev only): ${DEV_EXISTS}"
            echo "- **Blade Icons in composer.json**: ${HAS_BLADE}"
            echo "- **Bedrock vendor contains** \`owenvoke/blade-fontawesome\`: ${FA_PKG}"
            echo "- **Bedrock vendor contains** \`blade-ui-kit/blade-icons\`: ${BLADE_ICONS}"
            echo "- **Theme icons dir exists**: ${ICONS_DIR_EXISTS}"
            echo "- **Composer fallback (full install) used**: ${FALLBACK_USED}"
            echo ""
            echo "_Note: \`icons:cache\` runs only when Blade Icons are detected in composer.json._"
          } >> "$GITHUB_STEP_SUMMARY"
