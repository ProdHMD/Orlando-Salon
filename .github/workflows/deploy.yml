
name: Deploy Bedrock + Sage

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:
    inputs:
      app_env:
        description: "Override APP_ENV (live|dev). Leave empty to auto-detect from branch."
        required: false
        default: ""

env:
  # Only these need to exist as repo variables
  APP_NAME: ${{ vars.APP_NAME }}
  THEME_NAME: ${{ vars.THEME_NAME }}

jobs:
  sanity-and-derive:
    name: Derive & Validate Environment
    runs-on: ubuntu-latest
    outputs:
      app_env: ${{ steps.outvars.outputs.app_env }}
      deploy_path: ${{ steps.outvars.outputs.deploy_path }}
      theme_path: ${{ steps.outvars.outputs.theme_path }}
    steps:
      - name: Compute APP_ENV from branch (with optional override)
        id: outvars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          OVERRIDE="${{ github.event.inputs.app_env || vars.APP_ENV }}"
          if [ -n "$OVERRIDE" ]; then
            APP_ENV="$OVERRIDE"
          else
            case "$BRANCH" in
              master)  APP_ENV="live" ;;
              develop) APP_ENV="dev" ;;
              *) echo "Unsupported branch: $BRANCH" >&2; exit 1 ;;
            esac
          fi

          if [ -z "${{ env.APP_NAME }}" ]; then
            echo "Missing repo variable: APP_NAME" >&2
            exit 1
          fi
          if [ -z "${{ env.THEME_NAME }}" ]; then
            echo "Missing repo variable: THEME_NAME" >&2
            exit 1
          fi

          DEPLOY_PATH="/srv/users/serverpilot/apps/${APP_ENV}${{ env.APP_NAME }}"
          THEME_PATH="web/app/themes/${{ env.THEME_NAME }}"

          echo "Branch=$BRANCH  ;  APP_ENV=$APP_ENV"
          echo "deploy_path=$DEPLOY_PATH" >> "$GITHUB_OUTPUT"
          echo "theme_path=$THEME_PATH" >> "$GITHUB_OUTPUT"
          echo "app_env=$APP_ENV" >> "$GITHUB_OUTPUT"

  build-bedrock:
    name: Build Bedrock (Composer)
    needs: sanity-and-derive
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP 8.4 + Composer v2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2
          coverage: none

      - name: Cache Composer (project)
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
          key: composer-${{ hashFiles('**/composer.lock') }}

      - name: Install Bedrock Dependencies
        run: |
          composer --version
          composer install --no-interaction --prefer-dist --no-dev

      - name: Upload Bedrock Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bedrock-build
          path: |
            vendor/**
            .env
          if-no-files-found: ignore

  build-sage:
    name: Build Sage Assets (Node 20.20.0)
    needs: [sanity-and-derive, build-bedrock]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Bedrock Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bedrock-build

      - name: Setup PHP 8.4 + Composer (for theme/acorn)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2
          coverage: none

      - name: Setup Node 20.20.0
        uses: actions/setup-node@v4
        with:
          node-version: '20.20.0'
          cache: 'yarn'
          cache-dependency-path: ${{ needs.sanity-and-derive.outputs.theme_path }}/yarn.lock

      # ðŸ”’ Enforce Yarn 4.12.0 (prevents fallback to classic Yarn 1.x)
      - name: Use Yarn 4.12.0 via Corepack
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          yarn --version

      - name: Cache Composer (theme vendor)
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            ${{ needs.sanity-and-derive.outputs.theme_path }}/vendor
          key: composer-theme-${{ hashFiles(format('{0}/composer.lock', needs.sanity-and-derive.outputs.theme_path)) }}

      - name: Install Theme Dependencies + Build
        working-directory: ${{ needs.sanity-and-derive.outputs.theme_path }}
        run: |
          # Composer for Sage (Acorn, etc.)
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist --no-dev
          fi
          yarn install --immutable || yarn install
          yarn build

      - name: Upload Sage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sage-build
          path: |
            ${{ needs.sanity-and-derive.outputs.theme_path }}/public/**
            ${{ needs.sanity-and-derive.outputs.theme_path }}/vendor/**
            ${{ needs.sanity-and-derive.outputs.theme_path }}/node_modules/**
            ${{ needs.sanity-and-derive.outputs.theme_path }}/.yarn/**
          if-no-files-found: ignore

  deploy:
    name: Deploy via SSH + rsync
    needs: [sanity-and-derive, build-sage]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Bedrock Artifacts
        uses: actions/download-artifact@v4
        with:
          name: bedrock-build

      - name: Download Sage Artifacts
        uses: actions/download-artifact@v4
        with:
          name: sage-build
          path: .

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts

      # âœ… Option 1: STRICT SKIP if dev path doesn't exist
      - name: Check/flag dev path existence
        id: devpath
        if: needs.sanity-and-derive.outputs.app_env == 'dev'
        run: |
          if ssh serverpilot@${{ secrets.SERVER_IP }} "test -d '${{ needs.sanity-and-derive.outputs.deploy_path }}'"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip deploy if dev path missing
        if: needs.sanity-and-derive.outputs.app_env == 'dev' && steps.devpath.outputs.exists != 'true'
        run: |
          echo "Dev path ${{ needs.sanity-and-derive.outputs.deploy_path }} does not exist. Skipping deployment."
          exit 0

      - name: Rsync Bedrock & Theme to Server
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          set -e
          REMOTE="serverpilot@${{ secrets.SERVER_IP }}:${{ needs.sanity-and-derive.outputs.deploy_path }}"

          # Sync Bedrock vendor and .env
          rsync -az --delete vendor/ "$REMOTE/vendor/"
          [ -f ".env" ] && rsync -az .env "$REMOTE/.env" || true

          # Sync theme artifacts
          THEME_DIR="${{ needs.sanity-and-derive.outputs.theme_path }}"
          rsync -az --delete "$THEME_DIR/public/" "$REMOTE/$THEME_DIR/public/"
          if [ -d "$THEME_DIR/vendor" ]; then rsync -az --delete "$THEME_DIR/vendor/" "$REMOTE/$THEME_DIR/vendor/"; fi
          if [ -d "$THEME_DIR/node_modules" ]; then rsync -az --delete "$THEME_DIR/node_modules/" "$REMOTE/$THEME_DIR/node_modules/"; fi
          if [ -d "$THEME_DIR/.yarn" ]; then rsync -az --delete "$THEME_DIR/.yarn/" "$REMOTE/$THEME_DIR/.yarn/"; fi

      - name: Post-deploy tasks (Acorn optimize, perms)
        if: needs.sanity-and-derive.outputs.app_env == 'live' || steps.devpath.outputs.exists == 'true'
        run: |
          ssh serverpilot@${{ secrets.SERVER_IP }} bash -lc "
            set -e
            cd '${{ needs.sanity-and-derive.outputs.deploy_path }}'
            wp acorn optimize || true
            chown -R serverpilot:serverpilot .
            find . -type d -exec chmod 0775 {} \;
            find . -type f -exec chmod 0664 {} \;
            echo 'Deployment completed.'
          "
